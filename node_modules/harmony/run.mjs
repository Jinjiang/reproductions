import path from 'path'
import { createRequire } from 'module'
import findRoot from 'find-root'
import { generateRoot } from './generate-root.mjs'

const require = createRequire(import.meta.url)

const getAspect = (name) => {
  return {
    path: findRoot(require.resolve(name)),
    name,
    packageName: name
  }
}

export const run = async (config) => {
  Object.keys(config.runtimes).forEach(async (runtimeName) => {
    const rootPath = generateRoot(
      runtimeName,
      getAspect(config.platform), 
      config.aspects.map(aspect => getAspect(aspect))
    )
  
    const context = {
      root: rootPath,
      rootDir: path.dirname(rootPath)
    }

    const { run } = await import(config.runtimes[runtimeName])
    run(context)
  })
}
