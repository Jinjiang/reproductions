import fs from 'fs'
import path from 'path'

// for each aspect, it should contain:
// - path: the path to the aspect
// - name: the name of the aspect
// - packageName: the package name of the aspect

const getAspectRuntime = (aspect, runtimeName) => {
  const runtimePath = `${aspect.path}/${aspect.name}.${runtimeName}.js`
  if (fs.existsSync(runtimePath)) {
    return `${aspect.packageName}/${aspect.name}.${runtimeName}.js`
  }
  return null
}

export const generateRoot = (runtimeName, platformAspect, aspectList) => {
  const platformRuntime = getAspectRuntime(platformAspect, runtimeName)
  const platformTrigger = runtimeName === 'browser' ? 'render' : 'run'
  const platformImport = `import { ${platformTrigger} } from "${platformRuntime}";`
  const aspectImports = aspectList.map(aspect => {
    const aspectRuntime = getAspectRuntime(aspect, runtimeName)
    return aspectRuntime ? `import "${aspectRuntime}";` : null
  }).filter(Boolean)
  const imports = [platformImport, ...aspectImports].join('\n')
  const rootContent = `${imports}\n\n${platformTrigger}();`
  const rootPath = path.resolve(platformAspect.path, `root.${runtimeName}.mjs`)
  fs.writeFileSync(rootPath, rootContent)
  return rootPath
}
